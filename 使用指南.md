# DESI空间代谢组学分析系统 V2 - 使用指南

## 🎯 快速开始

### 1️⃣ 选择版本

我们提供两个版本：

| 版本 | 特点 | 适用场景 |
|------|------|----------|
| **简化版** | 快速、简洁 | 日常分析 |
| **完整版** | 功能全面 | 深入分析、发表论文 |

### 2️⃣ 启动GUI

**方法1：一键启动（推荐）**
```bash
# 完整功能版
cd "/Volumes/US100 256G/mouse DESI data/desi_gui_v2"
./START_FULL.sh
```

**方法2：直接运行**
```bash
cd "/Volumes/US100 256G/mouse DESI data/desi_gui_v2"

# 简化版
python3 main_gui.py

# 完整版
python3 main_gui_full.py
```

---

## 📋 基础操作（3步）

### 步骤1：打开工作目录
1. 点击顶部的 **"打开工作目录"** 按钮
2. 选择：`/Volumes/US100 256G/mouse DESI data`
3. 左上角会显示所有可用样本

### 步骤2：加载样本
1. 在样本列表中**双击**任意样本
2. 等待数据加载（约10-20秒）
3. 数据会自动显示在各个面板

### 步骤3：查看离子分布
1. 在左下角的离子表中**双击**任意行
2. 右上角的成像图会自动更新
3. 显示该m/z的空间分布

✅ **就这么简单！**

---

## 🔍 完整版特色功能

### 功能1：代谢物查询

**操作步骤**:
1. 右键点击离子表中的离子
2. 选择 **"代谢物查询"**
3. 查看匹配的代谢物及其误差

**或者**:
1. 菜单栏 → 分析 → 代谢物查询
2. 输入m/z值和容差
3. 点击 **"查询"**

**示例**:
- 查询 m/z 180.0634 → 匹配 Tyrosine
- 查询 m/z 165.0790 → 匹配 Phenylalanine

### 功能2：多离子对比

**操作步骤**:
1. 菜单栏 → 分析 → 多离子对比
2. 在列表中选择2-4个离子（按住Ctrl多选）
3. 点击 **"对比"**
4. 成像图会并排显示

**用途**:
- 对比不同代谢物的空间分布
- 查看共定位现象
- 分析代谢通路

### 功能3：色彩方案切换

**操作步骤**:
1. 点击工具栏的色彩方案下拉框
2. 选择喜欢的配色：
   - **hot**: 经典热力图（红黄白）
   - **viridis**: 色盲友好（蓝绿黄）
   - **plasma**: 高对比度（蓝紫红）
   - **jet**: 彩虹色
   - **coolwarm**: 冷暖对比（蓝白红）

### 功能4：峰标注

**操作步骤**:
1. 菜单栏 → 视图 → 显示峰标注（默认开启）
2. 光谱图会自动标注前20个最强峰的m/z值

**提示**: 取消勾选可隐藏标注，使图表更简洁

### 功能5：导出

**导出成像图**:
1. 菜单栏 → 文件 → 导出成像图
2. 选择格式（PNG/PDF）
3. 保存位置
4. 自动以300 DPI导出

**导出光谱图**: 同上

**导出离子表**:
1. 右键点击离子表
2. 选择 **"导出数据"**
3. 选择格式（Excel/CSV）
4. 保存

### 功能6：交互式工具栏

**成像图/光谱图工具栏功能**:
- 🏠 **Home**: 恢复默认视图
- ← **后退**: 返回上一个视图
- → **前进**: 前往下一个视图
- ➕ **放大**: 框选区域放大
- ✋ **平移**: 拖动图表
- 💾 **保存**: 快速保存当前图表

---

## 📊 典型工作流程

### 工作流程1：单样本分析

```
1. 启动GUI
   ↓
2. 打开工作目录
   ↓
3. 双击加载样本
   ↓
4. 浏览离子表，双击感兴趣的离子
   ↓
5. 查看空间分布
   ↓
6. 右键查询代谢物
   ↓
7. 导出成像图和数据
```

### 工作流程2：多离子对比

```
1. 加载样本
   ↓
2. 菜单 → 分析 → 多离子对比
   ↓
3. 选择2-4个离子（如：不同代谢物）
   ↓
4. 点击"对比"
   ↓
5. 观察空间分布的差异和相似性
   ↓
6. 调整色彩方案以获得最佳对比
   ↓
7. 导出对比图
```

### 工作流程3：代谢物鉴定

```
1. 加载样本
   ↓
2. 在离子表中寻找高强度离子
   ↓
3. 双击查看其空间分布
   ↓
4. 右键 → 代谢物查询
   ↓
5. 查看匹配结果（名称、分子式、误差）
   ↓
6. 记录鉴定结果
   ↓
7. 重复2-6步骤
```

---

## 💡 使用技巧

### 技巧1：快速定位感兴趣的离子

**方法**: 点击离子表的列标题进行排序
- 按 **"最大强度"** 排序 → 找到信号最强的离子
- 按 **"检出率"** 排序 → 找到普遍存在的离子
- 按 **"CV(%)"** 排序 → 找到变异大的离子

### 技巧2：快速切换m/z

**方法**: 使用顶部的m/z输入框
1. 输入m/z值
2. 按Enter或点击"更新成像图"
3. 成像图立即更新

### 技巧3：制作出版级图表

**步骤**:
1. 选择合适的色彩方案（推荐viridis或plasma）
2. 使用工具栏调整视图（放大感兴趣区域）
3. 关闭峰标注（如果不需要）
4. 导出为PDF格式（矢量图，可缩放）

### 技巧4：批量分析

**当前**: 手动逐个加载样本

**计划**: 后续版本将支持批量处理

---

## ❓ 常见问题

### Q1: 双击离子后成像图没有更新？

**A**: 检查以下几点：
1. 确认使用的是最新版本（V2）
2. 查看终端是否有错误信息
3. 尝试重启GUI

### Q2: 找不到样本？

**A**: 样本必须满足以下条件：
- 文件名以 `.raw` 结尾
- 包含 `imaging` 文件夹
- `imaging` 文件夹中有 `.txt` 文件

### Q3: 代谢物查询没有结果？

**A**: 可能原因：
1. m/z值超出数据库范围
2. 离子模式不匹配（正离子 vs 负离子）
3. 容差设置太小（建议10-20 ppm）

### Q4: 导出Excel失败？

**A**: 安装pandas和openpyxl：
```bash
pip3 install pandas openpyxl
```

### Q5: 成像图显示全黑？

**A**: 可能是该m/z的信号太弱，尝试：
1. 选择高强度的离子
2. 更换色彩方案
3. 检查数据是否正确加载

---

## 🔧 故障排除

### 问题1: GUI无法启动

**症状**: 双击后无反应或报错

**解决方案**:
```bash
# 检查Python版本
python3 --version  # 应该是3.6+

# 安装依赖
pip3 install PyQt5 matplotlib numpy pandas openpyxl

# 重新启动
python3 main_gui_full.py
```

### 问题2: 数据加载很慢

**症状**: 加载一个样本需要几分钟

**原因**: 数据文件很大（30k+扫描）

**正常**: 10-30秒是正常的

**加速**: 使用SSD存储数据

### 问题3: 内存不足

**症状**: 加载多个样本后系统变慢

**解决**: 
1. 一次只加载一个样本
2. 分析完后重启GUI
3. 关闭其他占内存的程序

---

## 📞 获取帮助

如果遇到问题：

1. **查看终端输出** - 通常有详细的错误信息
2. **阅读README.md** - 包含技术细节
3. **查看FEATURES.md** - 了解所有功能

---

## 🎉 开始分析！

现在你已经掌握了所有基础和高级功能，开始你的代谢组学数据分析之旅吧！

**祝数据分析顺利！** 🚀

