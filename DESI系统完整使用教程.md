# DESI空间代谢组学分析系统 - 完整使用教程

## 📋 系统概述

DESI（脱附电喷雾离子化）空间代谢组学分析系统是一个功能完整的桌面应用程序，用于处理和分析Waters DESI质谱成像数据。

### 🎯 核心功能
- ✅ **数据加载**: 支持Waters imaging预处理数据
- ✅ **成像可视化**: 多离子并排对比显示
- ✅ **离子信息表**: 统计分析和代谢物分类
- ✅ **质谱图显示**: 峰标注和范围选择
- ✅ **代谢物注释**: 本地+在线数据库查询
- ✅ **多离子对比**: 2-4个离子同时显示
- ✅ **ROI分析**: 交互式区域选择和分析
- ✅ **Lock Mass校准**: 质量校准和离子合并
- ✅ **数据过滤**: Top N离子选择和m/z范围过滤
- ✅ **导出功能**: 统计信息和二维空间数据导出

---

## 🚀 快速开始

### 1. 系统要求
```
Python >= 3.8
PyQt5 >= 5.15.0
numpy >= 1.21.0
pandas >= 1.3.0
matplotlib >= 3.4.0
scipy >= 1.7.0
```

### 2. 启动程序
```bash
cd "/Volumes/US100 256G/mouse DESI data/desi_gui_v2"
python3 main_gui_ultimate.py
```

### 3. 加载数据
- 点击 **"📂 打开工作目录"**
- 选择包含 `.raw` 文件的文件夹
- 系统会自动扫描并显示可用样本

---

## 📊 基本使用流程

### 第一步：数据加载
```
1. 启动程序
2. 点击 "📂 打开工作目录"
3. 选择数据文件夹（包含.raw文件）
4. 从左侧样本列表选择要分析的样本
5. 系统自动加载并显示数据
```

### 第二步：数据预处理（可选）
```
1. Lock Mass校准：🔧 → Lock Mass质量校准设置
2. 数据过滤：🔧 → 数据过滤设置
3. 质量校准会自动应用到所有后续分析
```

### 第三步：数据可视化
```
1. 选择感兴趣的m/z值（输入框或点击离子表）
2. 观察成像图和质谱图
3. 调整显示参数（颜色映射、对照等）
```

### 第四步：高级分析
```
1. 多离子对比：选择多个m/z进行并排显示
2. ROI分析：绘制区域进行局部分析
3. 代谢物查询：识别离子对应的代谢物
```

### 第五步：数据导出
```
1. 离子信息表 → 📋 导出离子数据
2. 选择导出格式（统计信息/二维空间信息）
3. 设置代谢物注释选项
4. 选择保存位置并导出
```

---

## 🎛️ 详细功能说明

### 1. 数据加载模块

#### 支持的数据格式
- Waters DESI imaging预处理数据（.raw文件夹）
- 自动识别正离子模式和负离子模式
- 支持批量样本处理

#### 加载步骤
1. **设置工作目录**
   - 点击主界面左上角"📂 打开工作目录"
   - 选择包含.raw文件的上级目录

2. **样本选择**
   - 左侧列表显示所有可用样本
   - 绿色✓表示有成像数据，红色✗表示无数据
   - 点击样本名称进行加载

3. **自动处理**
   - 解析.raw文件结构
   - 提取m/z和强度数据
   - 计算统计信息
   - 生成可视化图像

### 2. 成像可视化模块

#### 主要功能
- **单离子成像**: 输入m/z值显示对应图像
- **多离子对比**: 同时显示2-4个离子的成像
- **实时交互**: 鼠标悬停显示坐标和强度
- **参数调节**: 颜色映射范围、插值方法等

#### 使用方法
1. **单离子显示**
   - 在m/z输入框输入目标值
   - 或从离子表双击选择
   - 图像实时更新

2. **多离子对比**
   - 点击"🔍 多离子对比"按钮
   - 选择要对比的离子
   - 并排显示多个成像

3. **图像调节**
   - 右键菜单：调整颜色映射
   - 工具栏：缩放、平移等操作

### 3. 离子信息表模块

#### 功能特性
- 显示前100个高强度离子
- 包含统计信息（平均强度、最大强度、CV%）
- 支持排序和筛选
- 双击选择离子进行成像

#### 表格列说明
```
m/z: 质量电荷比
平均强度: 该离子在所有扫描点的平均强度
最大强度: 该离子的最大强度值
CV(%): 变异系数，反映离子分布均匀性
```

#### 导出功能
- **统计信息格式**: 包含代谢物注释的汇总表
- **二维空间信息格式**: 每个离子在所有扫描点的完整强度分布

### 4. 质谱图显示模块

#### 功能说明
- 显示平均质谱图（TIC归一化）
- 峰值标注和识别
- m/z范围选择
- 强度阈值调节

#### 分析方法
- **峰识别**: 自动识别主要峰
- **范围选择**: 拖拽选择感兴趣的m/z范围
- **强度过滤**: 只显示高强度峰

### 5. 代谢物注释模块

#### 数据源
- **本地HMDB数据库**: 完整的代谢物数据库
- **缓存系统**: 多级缓存提高查询速度
- **在线查询**: 补充查询（备用）

#### 注释流程
1. **自动注释**: 导出时自动进行
2. **手动查询**: 右键点击离子进行查询
3. **结果显示**: 分子式、分子量、CAS号、KEGG ID等

#### 缓存机制
- **内存缓存**: 最快，程序运行期间有效
- **数据库缓存**: 持久化存储，跨会话有效
- **HMDB数据库**: 完整数据源，查询最全面

### 6. ROI分析模块

#### 功能特性
- **矩形ROI**: 拖拽绘制矩形区域
- **多边形ROI**: 点击绘制复杂形状
- **多样本分析**: 跨样本ROI对比
- **统计分析**: 区域内离子强度统计

#### 使用步骤
1. **选择模式**: 点击"🖱️ 矩形ROI模式"
2. **绘制区域**: 按住鼠标左键拖拽
3. **查看结果**: 系统显示区域统计信息
4. **导出分析**: 保存ROI分析结果

### 7. Lock Mass校准模块

#### 原理说明
Lock Mass校准使用已知质量的参考离子来校正仪器漂移。

#### 配置步骤
1. **设置参数**
   - 参考m/z值（通常554.2615）
   - 容差范围（默认0.25 amu）
   - 离子合并参数

2. **自动校准**
   - 系统自动检测参考峰
   - 计算校正值
   - 应用到所有数据

3. **质量改善**
   - 校正m/z精度
   - 合并相似离子
   - 提高注释准确性

### 8. 数据过滤模块

#### 过滤选项
- **Top N离子**: 选择强度最高的N个离子
- **m/z范围**: 限制分析的m/z范围
- **目标离子**: 指定要分析的特定m/z值

#### 使用场景
- **减少数据量**: 提高处理速度
- **聚焦分析**: 只分析感兴趣的离子
- **内存优化**: 处理大型数据集

---

## 📁 数据导出功能

### 导出格式说明

#### 1. 统计信息格式
```
用途: 日常分析、统计汇总
包含: m/z、平均强度、最大强度、CV%、代谢物信息
文件大小: ~200 KB (500离子)
导出时间: ~30秒 (含注释)
```

#### 2. 二维空间信息格式
```
用途: 深度分析、自定义处理
包含: 每个离子在所有扫描点的强度分布
文件大小: ~200 MB (500离子)
导出时间: ~30秒
```

### 导出步骤
1. **打开导出对话框**
   ```
   离子信息表 → 📋 导出离子数据
   ```

2. **选择参数**
   ```
   导出数量: 全部离子 / Top N高强度离子
   导出格式: 统计信息 / 二维空间信息
   代谢物注释: 包含 / 不包含 (仅统计格式)
   ```

3. **选择文件位置**
   ```
   指定文件名和格式 (.xlsx / .csv)
   ```

4. **等待导出完成**
   ```
   观察进度条，等待完成提示
   ```

---

## 🔧 高级配置

### Lock Mass校准设置
```
位置: 菜单栏 → 🔧 工具 → Lock Mass质量校准设置
参数:
  - Lock Mass m/z: 参考离子质量 (默认554.2615)
  - 容差: 检测范围 (默认0.25 amu)
  - 最大信号强度: 过滤阈值 (默认0, 不限制)
  - 合并容差: 离子合并范围 (默认10 ppm)
```

### 数据过滤设置
```
位置: 菜单栏 → 🔧 工具 → 数据过滤设置
选项:
  - Top N离子: 选择前N个强度最高的离子
  - m/z范围: 设置最小/最大m/z值
  - 目标离子: 从文件导入特定m/z列表
```

### 系统配置
```
配置文件: desi_config.json (如存在)
包含: 默认参数、界面设置、数据库路径等
```

---

## ❓ 常见问题解决

### 问题1: 数据加载失败
```
原因: .raw文件结构不完整或损坏
解决: 检查.raw文件夹是否包含必要的文件
      尝试其他样本文件
```

### 问题2: 成像显示异常
```
原因: m/z值超出数据范围或强度太低
解决: 检查m/z输入是否正确
      调整颜色映射范围
      确认数据已正确加载
```

### 问题3: 代谢物注释为空
```
原因: 数据库未正确加载或m/z匹配失败
解决: 检查hmdb_database.db文件是否存在
      确认离子模式设置正确
      查看控制台错误信息
```

### 问题4: 导出时间过长
```
原因: 数据量过大或包含代谢物注释
解决: 选择Top N离子而不是全部导出
      取消代谢物注释选项
      使用统计信息格式而不是二维空间格式
```

### 问题5: 内存不足
```
原因: 处理大型数据集
解决: 使用数据过滤功能减少离子数量
      关闭其他程序释放内存
      分批处理数据
```

---

## 📈 性能优化建议

### 数据处理速度
1. **使用数据过滤**: 只处理感兴趣的离子
2. **合理设置参数**: 避免过度宽泛的搜索范围
3. **利用缓存**: 代谢物注释会自动缓存结果

### 内存使用优化
1. **限制离子数量**: 使用Top N过滤
2. **分批处理**: 避免同时加载过多样本
3. **及时清理**: 处理完一个样本后关闭

### 存储空间管理
1. **定期清理缓存**: 删除不必要的缓存文件
2. **压缩导出文件**: 使用.xlsx而不是.csv
3. **分卷存储**: 大文件可以分多个工作表

---

## 🔍 技术规格

### 系统要求
```
操作系统: macOS / Windows / Linux
内存: 至少8GB，推荐16GB以上
磁盘空间: 至少10GB可用空间
```

### 数据格式支持
```
输入格式: Waters DESI imaging .raw 文件夹
输出格式: Excel (.xlsx), CSV (.csv)
数据库: SQLite (HMDB代谢物数据库)
```

### 性能指标
```
数据加载: < 30秒 (典型样本)
成像渲染: < 5秒
代谢物注释: < 10秒 (缓存命中)
数据导出: 20-60秒 (取决于选项)
```

---

## 📞 技术支持

### 常见问题
- 查看本教程的"常见问题解决"章节
- 检查控制台输出的错误信息
- 确认数据文件完整性

### 进一步帮助
- 查看各功能模块的详细说明
- 检查配置文件和数据库文件
- 联系技术支持获取帮助

---

## 📝 更新日志

### v1.0.0 (最终版本)
- ✅ 完整实现所有核心功能
- ✅ 支持Lock Mass质量校准
- ✅ 代谢物注释系统
- ✅ ROI交互分析
- ✅ 双格式数据导出
- ✅ 多离子对比显示
- ✅ 数据过滤和优化

---

**🎉 感谢使用DESI空间代谢组学分析系统！**

如有问题或建议，请随时联系技术支持团队。

