# DESI软件商业化计费系统使用说明

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        简单计费方案                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  客户端（自动运行）                    管理端（你操作）            │
│  ┌─────────────────┐                 ┌─────────────────┐        │
│  │ DESI分析软件     │                 │ license_manager │        │
│  │                 │                 │                 │        │
│  │ • 自动记录使用量 │    定期发送     │ • 创建客户       │        │
│  │ • 本地加密存储   │ ──────────────▶ │ • 导入报告       │        │
│  │ • 导出使用报告   │   .enc文件      │ • 生成账单       │        │
│  └─────────────────┘                 └─────────────────┘        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 一、管理员操作流程

### 1. 创建新客户

```bash
python3 license_manager.py create --name "张三" --email "zhangsan@example.com" --company "XX大学"
```

输出：
```
✅ 客户创建成功！
   客户ID: CUST-A1B2C3D4
   License: DESI-XXXX1234-YYYY5678
   有效期至: 2026-12-11

请将License发送给客户。
```

### 2. 查看所有客户

```bash
python3 license_manager.py list
```

### 3. 导入客户使用报告

当客户发送使用报告文件（.enc）给你时：

```bash
python3 license_manager.py import /path/to/usage_report_20251211.enc
```

### 4. 查看客户使用量

```bash
python3 license_manager.py usage CUST-A1B2C3D4
```

### 5. 生成账单

```bash
# 默认单价 ¥10/样本
python3 license_manager.py invoice CUST-A1B2C3D4

# 自定义单价
python3 license_manager.py invoice CUST-A1B2C3D4 --price 15.0
```

---

## 二、客户操作流程

### 1. 首次使用

客户收到License后，软件会自动使用。
License存储在：`~/.desi_analytics/license.key`

如需手动设置，编辑该文件写入License即可。

### 2. 日常使用

软件会自动记录：
- 每次加载样本
- 每次导出数据
- 每次拆分代谢物

客户无需任何操作。

### 3. 导出使用报告

菜单栏 → 🔧 工具 → 📊 查看使用统计 → 导出报告

生成的 `.enc` 文件发送给管理员即可。

---

## 三、计费周期建议

| 方式 | 说明 |
|------|------|
| 月结 | 每月初收集上月报告，生成账单 |
| 季结 | 每季度收集报告 |
| 按需 | 客户需要时导出报告 |

---

## 四、文件说明

| 文件 | 说明 | 位置 |
|------|------|------|
| `usage_tracker.py` | 客户端追踪模块 | 随软件分发 |
| `license_manager.py` | 管理端工具 | 你自己保留 |
| `license_manager.db` | 客户和账单数据库 | 你自己保留 |
| `~/.desi_analytics/` | 客户本地数据 | 客户电脑 |

---

## 五、防篡改机制

1. **校验和验证**：每条记录都有基于机器ID的校验和
2. **完整性检查**：可检测数据是否被篡改
3. **加密存储**：使用Fernet对称加密

如果客户删除本地数据：
- 软件会重新开始记录
- 但之前已导出的报告仍然有效
- 建议定期（每月）收集报告

---

## 六、定价建议

| 计费模式 | 说明 |
|----------|------|
| 按样本数 | ¥10-50/样本 |
| 按月订阅 | ¥500-2000/月（不限样本） |
| 按年授权 | ¥5000-20000/年 |

---

## 七、快速开始

```bash
# 1. 创建第一个客户
python3 license_manager.py create --name "测试客户" --email "test@example.com"

# 2. 将License发给客户

# 3. 客户使用软件一段时间后...

# 4. 收集客户的使用报告文件

# 5. 导入报告
python3 license_manager.py import report.enc

# 6. 生成账单
python3 license_manager.py invoice CUST-XXXXXXXX
```

---

**注意**：`license_manager.py` 和 `license_manager.db` 请妥善保管，不要分发给客户！
