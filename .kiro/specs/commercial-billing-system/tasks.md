# 商业化计费系统实现任务列表

## 任务概述

本任务列表将商业化计费系统的设计转化为可执行的开发任务。任务按照依赖关系组织，确保每个任务都建立在前面任务的基础上。

---

## 阶段 1: 核心基础设施

- [x] 1. 重构和增强数据库管理器
  - 创建统一的DatabaseManager类，支持管理员和客户端两种模式
  - 实现完整的Schema定义，包含所有新增表（email_logs, backup_records等）
  - 添加数据库迁移功能，支持从旧版本平滑升级
  - 实现连接池和事务管理
  - _需求: 1.3, 1.5, 12.1_

- [x] 1.1 编写数据库管理器的单元测试
  - 测试表创建和Schema验证
  - 测试CRUD操作的正确性
  - 测试事务回滚和错误处理
  - _需求: 1.3, 1.5_

- [x] 2. 实现增强的加密解密模块
  - 重构DataEncryptor类，支持多种解密策略
  - 实现基于机器ID的密钥派生
  - 实现基于License的密钥派生
  - 添加自动尝试多种解密方法的功能
  - 实现加密数据的完整性验证
  - _需求: 2.2, 2.3, 6.4_

- [x] 2.1 编写加密模块的属性测试
  - **属性 11: 报告导出加密性（Round-trip）**
  - **验证: 需求 4.4, 6.4**
  - 测试任意数据的加密解密round-trip
  - 测试不同机器ID的加密兼容性
  - _需求: 2.2, 6.4_

- [x] 3. 创建License生成和验证模块
  - 实现LicenseGenerator类，生成唯一的License密钥
  - 实现LicenseValidator类，验证License有效性和到期时间
  - 添加License格式验证和校验位
  - 实现到期提醒逻辑（30天、7天、已过期）
  - _需求: 1.3, 5.1, 5.2, 5.3, 5.4_

- [x] 3.1 编写License模块的属性测试
  - **属性 1: License唯一性**
  - **验证: 需求 1.3**
  - **属性 2: 客户ID唯一性**
  - **验证: 需求 1.3**
  - **属性 12: License验证正确性**
  - **验证: 需求 5.1**
  - 测试大量License生成的唯一性
  - 测试各种到期时间的验证逻辑
  - _需求: 1.3, 5.1_

---

## 阶段 2: License Manager GUI开发

- [x] 4. 创建主窗口框架
  - 实现LicenseManagerGUI主窗口类
  - 创建菜单栏（文件、编辑、工具、帮助）
  - 创建工具栏，包含常用操作按钮
  - 创建状态栏，显示系统状态
  - 实现四面板布局（客户列表、详情、图表、账单）
  - _需求: 1.1_

- [x] 5. 实现客户管理功能
  - 创建CustomerListWidget，显示所有客户
  - 实现搜索、排序和筛选功能
  - 创建CreateCustomerDialog对话框
  - 创建EditCustomerDialog对话框
  - 实现客户信息的CRUD操作
  - _需求: 1.2, 1.3, 1.4, 1.5_

- [x] 5.1 编写客户管理的属性测试
  - **属性 3: 数据库更新一致性**
  - **验证: 需求 1.5**
  - 测试客户信息修改的一致性
  - 测试并发修改的处理
  - _需求: 1.5_

- [x] 6. 实现使用报告导入功能
  - 创建ImportReportDialog对话框
  - 实现拖拽文件导入功能
  - 实现多种解密方法的自动尝试
  - 添加导入进度显示
  - 实现重复报告检测
  - 显示导入摘要和统计信息
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 6.1 编写报告导入的属性测试
  - **属性 4: 报告解密成功性**
  - **验证: 需求 2.2, 2.3**
  - **属性 5: 重复报告检测**
  - **验证: 需求 2.5**
  - 测试各种加密报告的解密
  - 测试重复导入的检测
  - _需求: 2.2, 2.5_

- [x] 7. 实现账单生成和管理功能
  - 创建GenerateInvoiceDialog对话框
  - 实现多种计费模式选择（按样本数、按操作次数、订阅制、混合）
  - 实现账单金额计算逻辑
  - 创建InvoiceGenerator类
  - 实现账单文本导出功能
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_
  - _注: PDF和Excel导出功能将在任务7.2中实现_

- [x] 7.1 编写计费逻辑的属性测试
  - **属性 6: 按样本数计费正确性**
  - **验证: 需求 3.2**
  - **属性 7: 按操作次数计费正确性**
  - **验证: 需求 3.3**
  - **属性 8: 固定订阅计费正确性**
  - **验证: 需求 3.4**
  - **属性 21: 混合模式计费正确性**
  - **验证: 需求 7.5**
  - 测试各种计费模式的计算准确性
  - 测试边界情况和极端值
  - _需求: 3.2, 3.3, 3.4, 7.5_

- [ ] 7.2 编写账单导出的属性测试
  - **属性 9: 账单导出完整性**
  - **验证: 需求 3.5**
  - 测试PDF和Excel导出的完整性
  - 测试导出文件的格式正确性
  - _需求: 3.5_

---

## 阶段 3: 客户端使用追踪改进

- [x] 8. 重构UsageTracker类
  - 优化初始化流程，减少启动时间
  - 实现静默运行模式，无用户提示
  - 添加自动数据库修复功能
  - 优化记录性能，使用批量插入
  - 实现离线队列管理
  - _需求: 4.1, 4.2, 4.5_

- [x] 8.1 编写使用追踪的属性测试
  - **属性 10: 使用记录自动性**
  - **验证: 需求 4.2**
  - **属性 16: 校验和存在性**
  - **验证: 需求 6.1**
  - 测试各种操作的自动记录
  - 测试校验和的正确计算
  - _需求: 4.2, 6.1_

- [x] 9. 创建使用统计GUI界面
  - 创建UsageStatsDialog对话框
  - 实现图形化的使用报告展示
  - 添加使用趋势图表（matplotlib）
  - 显示详细的统计数据
  - 实现报告导出功能
  - _需求: 4.3, 4.4_

- [x] 10. 集成License验证到主程序
  - 在main_gui_ultimate.py中集成LicenseValidator
  - 实现启动时的License验证
  - 添加到期提醒对话框（30天、7天、已过期）
  - 实现过期后的功能限制
  - 添加License更新功能
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 10.1 编写License验证的属性测试
  - **属性 13: 到期提醒触发性**
  - **验证: 需求 5.2, 5.3**
  - **属性 14: 过期License功能限制**
  - **验证: 需求 5.4**
  - **属性 15: License更新生效性**
  - **验证: 需求 5.5**
  - 测试各种到期状态的处理
  - 测试功能限制的正确性
  - _需求: 5.2, 5.3, 5.4, 5.5_

---

## 阶段 4: 数据安全和完整性

- [x] 11. 实现完整性验证系统
  - 增强校验和计算逻辑
  - 实现批量完整性验证
  - 添加篡改检测和标记功能
  - 创建完整性报告生成器
  - 实现可疑记录的处理流程
  - _需求: 6.1, 6.2, 6.3, 6.5_

- [x] 11.1 编写完整性验证的属性测试
  - **属性 17: 完整性验证全面性**
  - **验证: 需求 6.2**
  - 测试所有记录的完整性验证
  - 测试篡改检测的准确性
  - _需求: 6.2_

---

## 阶段 5: 多计费模式支持

- [ ] 12. 实现计费模式管理
  - 创建BillingConfigDialog对话框
  - 实现计费模式的配置和保存
  - 添加客户级别的计费模式设置
  - 实现唯一样本统计逻辑
  - 实现操作次数统计逻辑
  - 实现混合模式计算逻辑
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 12.1 编写计费模式的属性测试
  - **属性 18: 唯一样本统计正确性**
  - **验证: 需求 7.2**
  - **属性 19: 操作次数统计正确性**
  - **验证: 需求 7.3**
  - **属性 20: 订阅制计费固定性**
  - **验证: 需求 7.4**
  - 测试各种统计逻辑的准确性
  - 测试边界情况
  - _需求: 7.2, 7.3, 7.4_

---

## 阶段 6: 报表和分析功能

- [ ] 13. 创建报表分析模块
  - 实现ReportAnalyzer类
  - 创建仪表板界面
  - 实现收入趋势分析和图表
  - 实现客户活跃度分析
  - 实现使用模式分析
  - 添加数据导出功能（Excel、PDF、CSV）
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 13.1 编写报表分析的属性测试
  - **属性 22: 收入趋势计算正确性**
  - **验证: 需求 8.2**
  - **属性 23: 客户活跃度统计正确性**
  - **验证: 需求 8.3**
  - **属性 24: 使用模式统计正确性**
  - **验证: 需求 8.4**
  - **属性 25: 报表导出格式正确性**
  - **验证: 需求 8.5**
  - 测试各种统计计算的准确性
  - 测试导出格式的正确性
  - _需求: 8.2, 8.3, 8.4, 8.5_

---

## 阶段 7: 客户自助服务门户（可选）

- [ ] 14. 创建Web门户后端
  - 选择Web框架（Flask或FastAPI）
  - 实现License认证API
  - 实现使用统计查询API
  - 实现账单历史查询API
  - 实现账单PDF下载API
  - 添加API安全防护（rate limiting、CORS）
  - _需求: 9.1, 9.2, 9.3, 9.4_

- [ ] 15. 创建Web门户前端
  - 设计响应式UI界面
  - 实现License登录页面
  - 实现个人仪表板
  - 实现使用历史查看页面
  - 实现账单历史查看页面
  - 添加续费提示和在线支付集成
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ]* 15.1 编写Web门户的属性测试
  - **属性 26: 客户门户认证正确性**
  - **验证: 需求 9.2**
  - **属性 27: 使用历史完整性**
  - **验证: 需求 9.3**
  - **属性 28: 账单历史完整性**
  - **验证: 需求 9.4**
  - **属性 29: 续费提示显示性**
  - **验证: 需求 9.5**
  - 测试认证逻辑的安全性
  - 测试数据查询的完整性
  - _需求: 9.2, 9.3, 9.4, 9.5_

---

## 阶段 8: 批量操作和自动化

- [ ] 16. 实现批量操作功能
  - 添加多选客户功能
  - 实现批量发送邮件
  - 实现批量更新状态
  - 实现批量生成账单
  - 实现批量导入使用报告
  - 添加进度条和结果摘要
  - _需求: 10.1, 10.4_

- [ ] 16.1 编写批量操作的属性测试
  - **属性 30: 批量操作正确性**
  - **验证: 需求 10.1**
  - **属性 33: 批量导入处理正确性**
  - **验证: 需求 10.4**
  - 测试批量操作的正确性
  - 测试错误处理和回滚
  - _需求: 10.1, 10.4_

- [ ] 17. 实现自动化任务系统
  - 创建TaskScheduler类
  - 实现定时任务调度（使用APScheduler）
  - 添加自动账单生成任务
  - 添加自动到期提醒任务
  - 实现任务日志和错误通知
  - 创建任务管理界面
  - _需求: 10.2, 10.3, 10.5_

- [ ] 17.1 编写自动化任务的属性测试
  - **属性 31: 自动账单生成准时性**
  - **验证: 需求 10.2**
  - **属性 32: 到期提醒自动发送性**
  - **验证: 需求 10.3**
  - 测试定时任务的准确性
  - 测试任务失败的处理
  - _需求: 10.2, 10.3_

---

## 阶段 9: 邮件通知系统

- [ ] 18. 实现邮件服务模块
  - 创建EmailService类
  - 配置SMTP连接
  - 实现邮件模板系统
  - 添加账单邮件模板
  - 添加到期提醒邮件模板
  - 添加欢迎邮件模板
  - 实现邮件发送队列和重试机制
  - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_

- [ ] 18.1 编写邮件服务的属性测试
  - **属性 34: 账单邮件自动发送性**
  - **验证: 需求 11.1**
  - **属性 35: License到期邮件发送性**
  - **验证: 需求 11.2**
  - **属性 36: 欢迎邮件发送性**
  - **验证: 需求 11.3**
  - 测试邮件发送的可靠性
  - 测试模板渲染的正确性
  - _需求: 11.1, 11.2, 11.3_

- [ ] 19. 创建邮件管理界面
  - 创建EmailTemplateDialog对话框
  - 实现模板编辑和预览功能
  - 创建邮件日志查看界面
  - 实现失败邮件重发功能
  - 添加自定义通知发送功能
  - _需求: 11.4, 11.5_

---

## 阶段 10: 数据备份和恢复

- [ ] 20. 实现备份系统
  - 创建BackupManager类
  - 实现完整备份功能
  - 实现增量备份功能
  - 添加自动备份调度（每7天）
  - 实现备份文件压缩
  - 添加备份完整性验证
  - _需求: 12.1, 12.2_

- [ ] 20.1 编写备份系统的属性测试
  - **属性 37: 备份完整性**
  - **验证: 需求 12.1**
  - **属性 38: 自动备份定时性**
  - **验证: 需求 12.2**
  - 测试备份的完整性
  - 测试自动备份的触发
  - _需求: 12.1, 12.2_

- [ ] 21. 实现恢复系统
  - 创建BackupRestoreDialog对话框
  - 实现备份文件选择和验证
  - 添加恢复前的当前数据备份
  - 实现数据恢复功能
  - 添加恢复进度显示
  - 实现恢复失败的回滚
  - _需求: 12.3, 12.4, 12.5_

- [ ] 21.1 编写恢复系统的属性测试
  - **属性 39: 备份验证正确性**
  - **验证: 需求 12.3**
  - **属性 40: 恢复前备份保护性**
  - **验证: 需求 12.4**
  - 测试备份验证的准确性
  - 测试恢复流程的安全性
  - _需求: 12.3, 12.4_

---

## 阶段 11: 集成和优化

- [x] 22. 集成所有模块到主程序
  - 更新main_gui_ultimate.py，集成新功能
  - 添加菜单项和工具栏按钮
  - 实现模块间的数据流
  - 优化启动性能
  - 添加配置文件支持
  - _需求: 所有_

- [x] 23. 性能优化
  - 优化数据库查询，添加索引
  - 实现数据分页加载
  - 优化大文件的加密解密性能
  - 添加缓存机制
  - 优化UI响应速度
  - _需求: 所有_

- [x] 24. 用户体验优化
  - 添加操作确认对话框
  - 实现撤销/重做功能
  - 添加键盘快捷键
  - 优化错误消息的友好性
  - 添加操作提示和帮助文档
  - _需求: 所有_

---

## 阶段 12: 测试和文档

- [ ] 25. 完善测试覆盖
  - 确保所有40个属性都有对应的属性测试
  - 添加缺失的单元测试
  - 编写端到端集成测试
  - 执行性能测试和压力测试
  - 执行安全测试
  - _需求: 所有_

- [ ] 26. 编写用户文档
  - 更新商业化计费系统使用说明.md
  - 编写管理员操作手册
  - 编写客户使用指南
  - 创建视频教程（可选）
  - 编写API文档（如果有Web门户）
  - _需求: 所有_

- [x] 27. 最终检查点 - 确保所有测试通过
  - 运行所有单元测试
  - 运行所有属性测试
  - 运行集成测试
  - 修复所有发现的问题
  - 确认系统稳定性
  - _需求: 所有_

---

## 任务执行说明

1. **按顺序执行**: 任务按照依赖关系组织，建议按顺序执行
2. **可选任务**: 标记为`*`的任务是可选的测试任务，可以根据时间和需求决定是否实施
3. **检查点**: 在每个阶段结束后，运行相关测试确保功能正常
4. **迭代开发**: 可以先实现核心功能，然后逐步添加高级特性
5. **用户反馈**: 在关键阶段完成后，收集用户反馈并调整计划

---

**总任务数**: 27个主任务 + 15个核心测试任务 + 6个可选测试任务（Web门户相关）
**预计开发时间**: 4-6周（取决于团队规模和经验）
**优先级**: 阶段1-5为高优先级，阶段6-10为中优先级，阶段11-12为收尾工作
**测试策略**: 核心功能的属性测试已标记为必需，确保全面的质量保证
