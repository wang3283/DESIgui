# 商业化计费系统需求文档

## 简介

DESI空间代谢组学分析系统的商业化计费系统旨在为软件提供完整的License管理、使用量追踪、账单生成和客户管理功能。当前系统已有基础实现，但存在易用性、功能完整性和用户体验方面的不足，需要进行全面改进。

## 术语表

- **License Manager**: License管理器，管理员使用的工具，用于创建客户、管理License、导入使用报告和生成账单
- **Usage Tracker**: 使用量追踪器，集成在客户端软件中，自动记录用户的使用行为
- **Customer**: 客户，购买和使用DESI软件的用户或机构
- **License Key**: License密钥，用于标识和验证客户身份的唯一字符串
- **Usage Report**: 使用报告，客户端生成的加密文件，包含使用统计信息
- **Invoice**: 账单，根据客户使用量生成的计费文档
- **Machine ID**: 机器标识，客户端计算机的唯一标识符
- **Checksum**: 校验和，用于验证数据完整性的哈希值
- **Encryption**: 加密，使用Fernet对称加密保护敏感数据
- **GUI**: 图形用户界面，提供可视化操作界面

## 需求

### 需求 1: License管理增强

**用户故事**: 作为管理员，我想要通过友好的GUI界面管理客户License，而不是使用命令行工具，这样我可以更高效地完成日常管理工作。

#### 验收标准

1. WHEN 管理员启动License管理器 THEN 系统应显示图形界面，包含客户列表、操作按钮和状态信息
2. WHEN 管理员点击"创建客户"按钮 THEN 系统应显示表单对话框，包含姓名、邮箱、公司、有效期等字段
3. WHEN 管理员填写完整信息并提交 THEN 系统应生成唯一的客户ID和License密钥，并显示成功消息
4. WHEN 管理员在客户列表中选择客户 THEN 系统应显示该客户的详细信息，包括使用统计和账单历史
5. WHEN 管理员修改客户信息 THEN 系统应验证输入并更新数据库，保持数据一致性

### 需求 2: 使用报告导入优化

**用户故事**: 作为管理员，我想要轻松导入客户的使用报告，系统能自动解密和识别客户，这样我不需要手动输入机器ID或其他复杂参数。

#### 验收标准

1. WHEN 管理员拖拽使用报告文件到GUI界面 THEN 系统应自动开始导入流程
2. WHEN 系统导入加密报告 THEN 系统应尝试多种解密方法，包括已知机器ID和License密钥
3. WHEN 解密成功 THEN 系统应自动识别客户并更新使用记录，显示导入摘要
4. WHEN 解密失败 THEN 系统应提示用户提供机器ID或联系客户，并记录失败日志
5. WHEN 导入重复报告 THEN 系统应检测并警告用户，避免重复计费

### 需求 3: 账单生成和管理

**用户故事**: 作为管理员，我想要灵活地生成和管理账单，支持多种计费模式和自定义参数，这样我可以适应不同的商业场景。

#### 验收标准

1. WHEN 管理员选择客户并点击"生成账单" THEN 系统应显示账单配置对话框，包含计费周期、单价、计费模式等选项
2. WHEN 管理员选择"按样本数计费"模式 THEN 系统应根据唯一样本数计算总金额
3. WHEN 管理员选择"按操作次数计费"模式 THEN 系统应根据加载、导出、拆分等操作次数计算总金额
4. WHEN 管理员选择"固定订阅"模式 THEN 系统应使用固定金额，不考虑使用量
5. WHEN 账单生成完成 THEN 系统应支持导出为PDF、Excel或打印格式，包含完整的账单信息和公司Logo

### 需求 4: 客户端使用追踪改进

**用户故事**: 作为软件用户，我想要使用追踪功能在后台静默运行，不影响我的正常工作，同时能够方便地查看自己的使用统计。

#### 验收标准

1. WHEN 用户首次启动软件 THEN 系统应自动初始化使用追踪器，无需用户干预
2. WHEN 用户加载样本、导出数据或拆分代谢物 THEN 系统应自动记录操作，不显示任何提示
3. WHEN 用户打开"使用统计"菜单 THEN 系统应显示图形化的使用报告，包含图表和详细数据
4. WHEN 用户点击"导出报告"按钮 THEN 系统应生成加密的.enc文件，并提示保存位置
5. WHEN 本地数据库损坏或丢失 THEN 系统应自动重建数据库，继续记录新的使用数据

### 需求 5: License验证和到期管理

**用户故事**: 作为管理员，我想要系统自动检查License有效期，并在到期前提醒客户续费，这样可以保证持续的收入流。

#### 验收标准

1. WHEN 客户端软件启动 THEN 系统应验证License密钥的有效性和到期时间
2. WHEN License将在30天内到期 THEN 系统应在软件启动时显示温和的续费提醒
3. WHEN License将在7天内到期 THEN 系统应每次启动时显示明显的续费警告
4. WHEN License已过期 THEN 系统应限制核心功能，只允许查看历史数据和导出使用报告
5. WHEN 用户输入新的License密钥 THEN 系统应验证并更新，立即恢复所有功能

### 需求 6: 数据安全和防篡改

**用户故事**: 作为管理员，我想要确保使用数据不被篡改，所有记录都有完整性验证，这样可以保证计费的准确性和公平性。

#### 验收标准

1. WHEN 系统记录使用数据 THEN 系统应计算并存储基于机器ID的校验和
2. WHEN 系统导入使用报告 THEN 系统应验证所有记录的完整性，检测任何篡改
3. WHEN 检测到数据篡改 THEN 系统应标记可疑记录，并在账单中注明
4. WHEN 客户端导出报告 THEN 系统应使用Fernet加密，确保传输过程中的安全性
5. WHEN 管理员查看完整性报告 THEN 系统应显示验证通过率和可疑记录详情

### 需求 7: 多计费模式支持

**用户故事**: 作为管理员，我想要支持多种灵活的计费模式，包括按量计费、订阅制和混合模式，这样可以满足不同客户的需求。

#### 验收标准

1. WHEN 管理员创建客户 THEN 系统应允许选择计费模式：按样本数、按操作次数、月订阅、年订阅或自定义
2. WHEN 客户使用"按样本数"模式 THEN 系统应只统计唯一样本数，忽略重复加载
3. WHEN 客户使用"按操作次数"模式 THEN 系统应统计所有操作，包括加载、导出和拆分
4. WHEN 客户使用"订阅制"模式 THEN 系统应按固定周期收费，不限制使用量
5. WHEN 客户使用"混合模式" THEN 系统应结合基础订阅费和超额使用费计算总金额

### 需求 8: 报表和分析功能

**用户故事**: 作为管理员，我想要查看全面的业务报表和分析，包括收入趋势、客户活跃度和使用模式，这样可以做出更好的商业决策。

#### 验收标准

1. WHEN 管理员打开"报表"菜单 THEN 系统应显示仪表板，包含关键指标和图表
2. WHEN 管理员查看收入报表 THEN 系统应显示按月、按季度和按年的收入趋势图
3. WHEN 管理员查看客户活跃度 THEN 系统应显示活跃客户数、新增客户数和流失客户数
4. WHEN 管理员查看使用模式 THEN 系统应显示最常用功能、平均样本数和使用时段分布
5. WHEN 管理员导出报表 THEN 系统应支持导出为Excel、PDF或CSV格式

### 需求 9: 客户自助服务门户

**用户故事**: 作为客户，我想要通过Web门户查看自己的使用情况和账单历史，这样我可以随时了解费用情况，无需联系管理员。

#### 验收标准

1. WHEN 客户访问自助门户 THEN 系统应要求输入License密钥进行身份验证
2. WHEN 客户登录成功 THEN 系统应显示个人仪表板，包含当前使用量和账单状态
3. WHEN 客户查看使用历史 THEN 系统应显示按日期排序的详细使用记录
4. WHEN 客户查看账单历史 THEN 系统应显示所有历史账单，支持下载PDF
5. WHEN 客户的License即将到期 THEN 系统应显示续费按钮和在线支付选项

### 需求 10: 批量操作和自动化

**用户故事**: 作为管理员，我想要批量处理多个客户的操作，并设置自动化任务，这样可以节省大量时间。

#### 验收标准

1. WHEN 管理员选择多个客户 THEN 系统应支持批量操作，包括发送邮件、更新状态和生成账单
2. WHEN 管理员设置自动账单生成 THEN 系统应在每月指定日期自动为所有活跃客户生成账单
3. WHEN 管理员设置到期提醒 THEN 系统应自动发送邮件提醒即将到期的客户
4. WHEN 管理员导入多个使用报告 THEN 系统应支持批量导入，显示进度条和结果摘要
5. WHEN 自动化任务执行失败 THEN 系统应记录错误日志，并通过邮件通知管理员

### 需求 11: 邮件通知系统

**用户故事**: 作为管理员，我想要系统自动发送邮件通知给客户，包括账单、到期提醒和重要公告，这样可以保持良好的客户沟通。

#### 验收标准

1. WHEN 账单生成完成 THEN 系统应自动发送账单邮件给客户，附带PDF附件
2. WHEN License即将到期 THEN 系统应发送提醒邮件，包含续费链接和联系方式
3. WHEN 客户首次创建 THEN 系统应发送欢迎邮件，包含License密钥和使用指南
4. WHEN 管理员发送自定义通知 THEN 系统应支持选择收件人、编辑内容和预览效果
5. WHEN 邮件发送失败 THEN 系统应记录失败原因，并在管理界面显示待重发列表

### 需求 12: 数据备份和恢复

**用户故事**: 作为管理员，我想要定期备份所有客户数据和使用记录，并能够快速恢复，这样可以防止数据丢失。

#### 验收标准

1. WHEN 管理员点击"备份数据"按钮 THEN 系统应导出完整的数据库副本，包含所有表和记录
2. WHEN 系统运行超过7天 THEN 系统应自动创建增量备份，保存到指定目录
3. WHEN 管理员选择备份文件并点击"恢复" THEN 系统应验证备份完整性，并提示确认恢复操作
4. WHEN 恢复操作执行 THEN 系统应先备份当前数据，然后替换为历史数据
5. WHEN 备份文件损坏或不完整 THEN 系统应拒绝恢复，并显示详细的错误信息
